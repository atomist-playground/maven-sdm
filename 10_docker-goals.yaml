docker_build:    
  test: 
  - has_file: Dockerfile  
    
  depends_on: 
  - mvn_build
  - node_build
         
  goals:   
#  - containers:   
#    - name: kaniko
#      image: gcr.io/kaniko-project/executor
#      args: 
#      - --context=dir:///atm/home
#      - --destination=atomist/${push.repo.name}:${push.after.sha}
#      - --dockerfile=Dockerfile
#      - --cache=true
#      - --cache-repo=atomist/layer-cache
#      volume_mounts:
#      - name: creds
#        mount_path: /kaniko/.docker/config.json
#    volumes:
#    - name: creds
#      host_path:
#        path: ${home}/.docker/config.json
  - containers:
    - name: docker-build
      image: docker
      args:
      - /bin/sh
      - -c
      - >-
        docker build . -f Dockerfile -t atomist/${push.repo.name}:${push.after.sha} && 
        docker push atomist/${push.repo.name}:${push.after.sha} &&
        echo '{ "data": "{ \"image\": \"atomist/${push.repo.name}:${push.after.sha}\" }" }' > $ATOMIST_RESULT
      volume_mounts:
      - name: sock
        mount_path: /var/run/docker.sock
      - name: creds
        mount_path: /root/.docker/config.json        
    input: 
    - cache
    volumes:
    - name: sock
      host_path:
        path: /var/run/docker.sock
    - name: creds
      host_path:
        path: ${home}/.docker/config.json
