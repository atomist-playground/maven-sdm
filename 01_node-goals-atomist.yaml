configuration:
  logging:
    level: info
  sdm:
    cache:
      enabled: true
      path: /tmp/cache
    goal:
      timeout: 1200000
      docker:
        registry: atomistplayground
        provider: atomist

  # Configure goal Docker images here
  images:
  - &version_image atomist/version-goal:0.1.0-master.20191112221212
  - &node_image node:lts
  - &docker_image docker:19.03.4

  # Set up some common secrets to be used by goals
  secrets:
    npmjs: &secret_npmjs
      mount_path: /root/.npmrc
      value:
        provider:
          type: npm
          names:
            - npmjs
    docker: &secret_docker
      mount_path: /root/.docker/config.json
      value:
        provider:
          type: docker
          names:
            - atomist

immaterial:
  test:
  - not:
      is_material_change:
        files:
          - package.json
          - Dockerfile
        extensions:
          - ts

  goals: lock

node_build:
  test: 
  - has_file: package.json
     
  goals:
  - atomist/version-goal@master
  - atomist/npm-goal@master
    name: npm-test
  - atomist/npm-goal@master
    name: npm-publish
    - constainers:
      - secrets:
        file_mounts:
        - <<: *secret_npmjs
  - tag

docker_build:
  test:
    - has_file: package.json
    - has_file: Dockerfile

  depends_on:
    - node_build

  goals:
  - containers:
    - name: docker build
      image: *docker_image
      args:
      - sh
      - -c
      - >-
        docker build . -f Dockerfile -t atomist/${push.repo.name}:${push.after.version} &&
        docker push atomist/${push.repo.name}:${push.after.version} &&
        echo '{ "SdmGoal": { "push": { "after": { "images" :[{ "imageName": "atomist/${push.repo.name}:${push.after.version}" }] } } } }' > $ATOMIST_RESULT
      volume_mounts:
      - name: sock
        mount_path: /var/run/docker.sock
      secrets:
        file_mounts:
        - <<: *secret_docker
    input:
    - version
    - compile-ts
    volumes:
    - name: sock
      host_path:
        path: /var/run/docker.sock
    retry: true
